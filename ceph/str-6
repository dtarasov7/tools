–ü–æ—á–µ–º—É radosgw-admin user list –∑–∞–≤–∏—Å–∞–µ—Ç –≤ Ceph v17 (Stretch mode) –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∏–∑ –¶–û–î?
üö® –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–∏—Å–∞–Ω–∏—è: RGW (RADOS Gateway) –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ metadata pool, —Ç–∞–∫ –∫–∞–∫ Quorum –ø–æ—Ç–µ—Ä—è–Ω –∏–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö PG –≤ –ø—É–ª–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.

üîπ –†–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏
–í —Ä–µ–∂–∏–º–µ Stretch Mode Ceph –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö –¶–û–î–∞ + 1 —Ç–∞–π–±—Ä–µ–π–∫–µ—Ä (–∞—Ä–±–∏—Ç—Ä).
–í–∞—à —Å—Ü–µ–Ω–∞—Ä–∏–π:

–ï—Å—Ç—å 2 –¶–û–î–∞ (–ø–æ 4 OSD-—Å–µ—Ä–≤–µ—Ä–∞, 4 OSD –Ω–∞ –∫–∞–∂–¥–æ–º).

–û–¥–∏–Ω –∏–∑ –¶–û–î–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã—à–µ–ª –∏–∑ —Å—Ç—Ä–æ—è.

radosgw-admin user list –∑–∞–≤–∏—Å–∞–µ—Ç.

üîç –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç?

RGW —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (metadata pool).

–≠—Ç–æ—Ç –ø—É–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç replication –∏–ª–∏ EC (Erasure Coding), –∏ PG –º–æ–≥—É—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–æ—Å–ª–µ –ø–æ—Ç–µ—Ä–∏ –¶–û–î–∞.

–ï—Å–ª–∏ metadata pool –ø–æ—Ç–µ—Ä—è–ª PG (Placement Groups), —Ç–æ –∑–∞–ø—Ä–æ—Å—ã –∫ –Ω–µ–º—É –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.

üìå –ß—Ç–æ –¥–µ–ª–∞—Ç—å? (–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
ceph status
–ï—Å–ª–∏ —É–≤–∏–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞:

plaintext
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
HEALTH_WARN Reduced data availability: X PGs inactive, Y PGs peering
—ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ PG –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏ –ø—É–ª —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å.

2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ metadata pool
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
ceph osd pool ls detail | grep rgw
–ò–ª–∏:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
ceph pg dump pgs_brief | grep -E 'rgw|metadata'
üìå –ï—Å–ª–∏ PG –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ peering, stale, inactive+down ‚Üí –∑–Ω–∞—á–∏—Ç, Ceph –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∫ –Ω–∏–º –¥–æ—Å—Ç—É–ø.

3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–∫–æ–ª—å–∫–æ –∫–æ–ø–∏–π –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–æ
–ï—Å–ª–∏ –ø—É–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ replicated, —Å–º–æ—Ç—Ä–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–ø–ª–∏–∫:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
ceph osd pool get <metadata_pool> size
ceph osd pool get <metadata_pool> min_size
–ï—Å–ª–∏ min_size > 2, –Ω–æ –æ–¥–∏–Ω –¶–û–î –æ—Ç–∫–ª—é—á–µ–Ω, —Ç–æ Ceph –Ω–µ –¥–∞—Å—Ç —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–Ω–∞ –∫–æ–ø–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞.

üìå –ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?
‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1: –£–º–µ–Ω—å—à–∏—Ç—å min_size, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
ceph osd pool set <metadata_pool> min_size 1
üîπ –í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø–∏—Å–∏.

‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–µ—Ä–µ–Ω–æ—Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—É–ª
–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–µ OSD, –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—É–ª –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:

1Ô∏è‚É£ –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø—É–ª (–µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–µ—Ä—è–ª quorum)

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
ceph osd pool create new_metadata_pool 128 128 replicated
2Ô∏è‚É£ –ú–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Ceph RGW –Ω–∞ –Ω–æ–≤—ã–π –ø—É–ª

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
radosgw-admin zone modify --rgw-zone=default --metadata-pool=new_metadata_pool
radosgw-admin period update --commit
3Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º RADOS Gateway

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
systemctl restart ceph-radosgw.target
‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Quorum MON-–æ–≤
–ï—Å–ª–∏ MON-—ã –Ω–µ –º–æ–≥—É—Ç –≤—ã–±—Ä–∞—Ç—å –ª–∏–¥–µ—Ä–∞ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è quorum, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å quorum —Ç–æ–ª—å–∫–æ —Å –æ—Å—Ç–∞–≤—à–∏–º–∏—Å—è MON-–∞–º–∏:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
ceph mon quorum_status
ceph mon enable_stretch_mode --force
üìå –ò—Ç–æ–≥
Ceph –∑–∞–≤–∏—Å–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ RGW –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ metadata pool.

–ü—Ä–æ–±–ª–µ–º–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –ø–æ—Ç–µ—Ä–µ–π PG –∏–∑-–∑–∞ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –¶–û–î–∞.

–†–µ—à–µ–Ω–∏–µ: —É–º–µ–Ω—å—à–∏—Ç—å min_size, –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—ã–π –ø—É–ª –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å quorum MON-–æ–≤.

üöÄ –õ—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 3 –∑–æ–Ω—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è (3 –¶–û–î–∞) –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É–ª –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å size=3 –∏ min_size=2.

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ! üòä
