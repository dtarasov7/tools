ceph 17.2
ansible 2.12
Ð˜ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ð½Ñ‹ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ . ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹
Project:
  project1:
    name: "nameproject1"
    placement: placementproject1
    admin: 
      name: xadmin
      secret_key: "xxx"
      access_key: "yyy"
    backets:
      bucket1:
        name: namebucket1
      bucket2:
        name: namebucket2
    users:
      user1:
        name: nameuser1
        policies:
          policy1:
            name: policyname
            sid: #ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚ Ñ policy1.name
            effect: allow
            action:
              - add
              - del
            resorce: 
              - "arn:::b1"
              - "arn:::b1/*"

ÐÐ°Ð¿Ð¸ÑˆÐ¸ ÐºÐ¾Ð´ Ð½Ð° ansible, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ buckets , Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹(users) Ð¸ Ð½Ð°Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸.
Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¸ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ° Ð¸Ñ… Ðº placement - Ñ‡ÐµÑ€ÐµÐ· radosgw-admin .
CÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°ÐºÐµÑ‚Ð¾Ð² Ð¸ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ° Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ñ‡ÐµÑ€ÐµÐ· aws (v1) c Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð° ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ( Ð¾Ð½ Ð¸Ð¼ÐµÐµÑ‚ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð°).


ChatGPT ÑÐºÐ°Ð·Ð°Ð»:
Ð’Ð¾Ñ‚ ÐºÐ¾Ð´ Ansible, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹:
âœ… Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð±Ð°ÐºÐµÑ‚Ñ‹ Ñ‡ÐµÑ€ÐµÐ· AWS CLI Ñ ÑƒÑ‡Ñ‘Ñ‚Ð¾Ð¼ ÑƒÑ‡Ñ‘Ñ‚Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.
âœ… Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· radosgw-admin.
âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· AWS CLI.

ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ñ‹ ÐºÐ¾Ð´Ð°
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ ansible.builtin.shell, Ñ‚Ð°Ðº ÐºÐ°Ðº radosgw-admin Ð¸ aws Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ñ‡ÐµÑ€ÐµÐ· CLI.

Ð›Ð¾Ð³Ð¸ÐºÐ° Ñ€Ð°Ð·Ð±Ð¸Ñ‚Ð° Ð¿Ð¾ ÑˆÐ°Ð³Ð°Ð¼: ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, Ð±Ð°ÐºÐµÑ‚Ð¾Ð² Ð¸ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº.

Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÐµÑ€ÑƒÑ‚ÑÑ Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Project.

ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· with_dict Ð¸ with_items, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð»ÑŽÐ±Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð², Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¸ Ð±Ð°ÐºÐµÑ‚Ð¾Ð².

Ansible Playbook
yaml
ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
- name: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ceph S3 Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¸ Ð±Ð°ÐºÐµÑ‚Ð¾Ð²
  hosts: localhost
  gather_facts: no
  vars:
    Project:
      project1:
        name: "nameproject1"
        placement: placementproject1
        admin: 
          name: xadmin
          secret_key: "xxx"
          access_key: "yyy"
        buckets:
          bucket1:
            name: namebucket1
          bucket2:
            name: namebucket2
        users:
          user1:
            name: nameuser1
            policies:
              policy1:
                name: policyname
                sid: policyname  # ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚ Ñ policy1.name
                effect: allow
                action:
                  - add
                  - del
                resource: 
                  - "arn:::b1"
                  - "arn:::b1/*"

  tasks:
    - name: "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² Ceph"
      ansible.builtin.shell: |
        radosgw-admin user create --uid={{ item.value.name }} \
          --display-name="{{ item.value.name }}" \
          --placement-id={{ Project[item.key].placement }}
      with_dict: "{{ Project.project1.users }}"
      register: user_creation
      changed_when: "'user_info' in user_creation.stdout"

    - name: "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°ÐºÐµÑ‚Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· AWS S3 CLI"
      ansible.builtin.shell: |
        AWS_ACCESS_KEY_ID={{ Project.project1.admin.access_key }} \
        AWS_SECRET_ACCESS_KEY={{ Project.project1.admin.secret_key }} \
        aws --endpoint-url http://ceph-s3.example.com s3api create-bucket --bucket {{ item.value.name }}
      with_dict: "{{ Project.project1.buckets }}"
      register: bucket_creation
      changed_when: "'Bucket' in bucket_creation.stdout"

    - name: "ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼"
      ansible.builtin.shell: |
        cat > /tmp/policy_{{ item.0.value.name }}.json <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "{{ item.1.value.sid }}",
              "Effect": "{{ item.1.value.effect | capitalize }}",
              "Action": {{ item.1.value.action | to_json }},
              "Resource": {{ item.1.value.resource | to_json }}
            }
          ]
        }
        EOF
        AWS_ACCESS_KEY_ID={{ Project.project1.admin.access_key }} \
        AWS_SECRET_ACCESS_KEY={{ Project.project1.admin.secret_key }} \
        aws --endpoint-url http://ceph-s3.example.com s3api put-bucket-policy \
          --bucket {{ Project.project1.buckets.bucket1.name }} \
          --policy file:///tmp/policy_{{ item.0.value.name }}.json
      with_subelements:
        - "{{ Project.project1.users }}"
        - policies
      register: policy_assignment
      changed_when: "'Policy' in policy_assignment.stdout"
ÐšÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÑÑ‚Ð¾Ñ‚ Playbook?
ðŸ”¹ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² Ceph Ñ‡ÐµÑ€ÐµÐ· radosgw-admin.
ðŸ”¹ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð±Ð°ÐºÐµÑ‚Ñ‹ Ñ‡ÐµÑ€ÐµÐ· AWS CLI, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ ÑƒÑ‡Ñ‘Ñ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.
ðŸ”¹ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ JSON-Ñ„Ð°Ð¹Ð» Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ ÐµÐ³Ð¾ Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ñ‡ÐµÑ€ÐµÐ· AWS S3 API.

Ð­Ñ‚Ð¾Ñ‚ ÐºÐ¾Ð´ Ð³Ð¸Ð±ÐºÐ¸Ð¹ Ð¸ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½ Ð´Ð»Ñ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð² Ñ Ñ€Ð°Ð·Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸ Ð¸ Ð±Ð°ÐºÐµÑ‚Ð°Ð¼Ð¸. ðŸš€







Ð’Ñ‹ ÑÐºÐ°Ð·Ð°Ð»Ð¸:
Ð² Ð·Ð´ÐµÑÑŒ 
aws --endpoint-url http://ceph-s3.example.com s3api put-bucket-policy \
          --bucket {{ Project.project1.buckets.bucket1.name }} \
          --policy file:///tmp/policy_{{ item.0.value.name }}.json
Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ iam Ð° Ð½Ðµ s3api. Ð˜ Ð½Ð°Ð´Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ uid Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼Ñƒ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°

ÐºÑ€Ð¾Ð¼Ðµ Ñ‚Ð¾Ð³Ð¾ Ð´Ð¾Ð±Ð°Ð²ÑŒ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ caps, Ð·Ð°Ð´Ð°Ð²Ð°ÐµÐ¼Ð¾Ð³Ð¾ Ð² Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
    users:
      user1:
        name: nameuser1
        caps: "zone:*;user:*"
        policies:
Ð”Ð¾Ð±Ð°Ð²ÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ñ‚Ð¾Ð³Ð¾ . Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚. Ð”Ð»Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð°Ð´Ð¾:
- Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¸Ð¼ÐµÑŽÑ‰Ð¸ÐµÑÑ caps Ð¸Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ aps
- ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð¼ÐµÑŽÑ‰Ð¸ÐµÑÑ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ (aws iam) Ð½Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð½Ñ‹Ðµ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ projects
- Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
- Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸

Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½ Ð² Projects, Ð½Ð¾ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ñ‚Ð¾ ÐµÐ³Ð¾ Ð½Ð°Ð´Ð¾ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð° Ð¿Ð°ÑƒÐ·Ñƒ.



ChatGPT ÑÐºÐ°Ð·Ð°Ð»:
Ð’Ð¾Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ansible Playbook, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹:
âœ… Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¸ Ð±Ð°ÐºÐµÑ‚Ñ‹ (ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚).
âœ… Ð˜Ð·Ð¼ÐµÐ½ÑÐµÑ‚ caps Ñƒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ (ÐµÑÐ»Ð¸ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÑŽÑ‚ÑÑ).
âœ… Ð£Ð´Ð°Ð»ÑÐµÑ‚ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ.
âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ñ‡ÐµÑ€ÐµÐ· AWS IAM, Ð° Ð½Ðµ s3api.
âœ… ÐŸÑ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ (suspended: true) Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚ Ð² Project, Ð½Ð¾ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ Ð² Ceph.

Ansible Playbook
yaml
ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
- name: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ceph S3 Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¸ Ð±Ð°ÐºÐµÑ‚Ð¾Ð²
  hosts: localhost
  gather_facts: no
  vars:
    ceph_endpoint: "http://ceph-s3.example.com"
    Project:
      project1:
        name: "nameproject1"
        placement: placementproject1
        admin: 
          name: xadmin
          secret_key: "xxx"
          access_key: "yyy"
        buckets:
          bucket1:
            name: namebucket1
          bucket2:
            name: namebucket2
        users:
          user1:
            name: nameuser1
            caps: "zone:*;user:*"
            policies:
              policy1:
                name: policyname
                sid: policyname
                effect: allow
                action:
                  - add
                  - del
                resource: 
                  - "arn:::b1"
                  - "arn:::b1/*"

  tasks:

    # --- ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² Ceph ---
    - name: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
      ansible.builtin.shell: radosgw-admin user list | jq -r '.[]'
      register: existing_users
      changed_when: false

    - name: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
      ansible.builtin.set_fact:
        existing_users_list: "{{ existing_users.stdout_lines }}"

    # --- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ ---
    - name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼/Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
      ansible.builtin.shell: |
        radosgw-admin user info --uid={{ item.value.name }} 2>/dev/null || echo "USER_NOT_FOUND"
      register: user_info
      changed_when: false
      with_dict: "{{ Project.project1.users }}"

    - name: "Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð½Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² Ceph"
      ansible.builtin.shell: |
        radosgw-admin user create --uid={{ item.value.name }} \
          --display-name="{{ item.value.name }}" \
          --placement-id={{ Project.project1.placement }} \
          --caps="{{ item.value.caps }}"
      when: "'USER_NOT_FOUND' in item.1.stdout"
      with_dict: "{{ Project.project1.users }}"
      register: user_creation

    - name: "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ caps Ñƒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹"
      ansible.builtin.shell: |
        radosgw-admin user modify --uid={{ item.value.name }} --caps="{{ item.value.caps }}"
      when: "'USER_NOT_FOUND' not in item.1.stdout"
      with_dict: "{{ Project.project1.users }}"
      register: user_caps_update
      changed_when: "'caps' in user_caps_update.stdout"

    # --- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°ÐºÐµÑ‚Ð¾Ð² ---
    - name: "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°ÐºÐµÑ‚Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· AWS S3 CLI"
      ansible.builtin.shell: |
        AWS_ACCESS_KEY_ID={{ Project.project1.admin.access_key }} \
        AWS_SECRET_ACCESS_KEY={{ Project.project1.admin.secret_key }} \
        aws --endpoint-url {{ ceph_endpoint }} s3api create-bucket --bucket {{ item.value.name }}
      with_dict: "{{ Project.project1.buckets }}"
      register: bucket_creation
      changed_when: "'Bucket' in bucket_creation.stdout"

    # --- ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ ---
    - name: "ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹"
      ansible.builtin.shell: |
        AWS_ACCESS_KEY_ID={{ Project.project1.admin.access_key }} \
        AWS_SECRET_ACCESS_KEY={{ Project.project1.admin.secret_key }} \
        aws --endpoint-url {{ ceph_endpoint }} iam list-user-policies --user-name {{ item.value.name }} | jq -r '.PolicyNames[]'
      register: current_policies
      with_dict: "{{ Project.project1.users }}"
      changed_when: false

    - name: "Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸, Ð½Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð½Ñ‹Ðµ Ð² Project"
      ansible.builtin.shell: |
        AWS_ACCESS_KEY_ID={{ Project.project1.admin.access_key }} \
        AWS_SECRET_ACCESS_KEY={{ Project.project1.admin.secret_key }} \
        aws --endpoint-url {{ ceph_endpoint }} iam delete-user-policy \
          --user-name {{ item.0.value.name }} --policy-name {{ item.1 }}
      when: item.1 not in item.0.value.policies.keys()
      with_subelements:
        - "{{ Project.project1.users }}"
        - current_policies.stdout_lines

    - name: "ÐÐ°Ð·Ð½Ð°Ñ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ñ‡ÐµÑ€ÐµÐ· AWS IAM"
      ansible.builtin.shell: |
        cat > /tmp/policy_{{ item.0.value.name }}.json <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "{{ item.1.value.sid }}",
              "Effect": "{{ item.1.value.effect | capitalize }}",
              "Action": {{ item.1.value.action | to_json }},
              "Resource": {{ item.1.value.resource | to_json }}
            }
          ]
        }
        EOF
        AWS_ACCESS_KEY_ID={{ Project.project1.admin.access_key }} \
        AWS_SECRET_ACCESS_KEY={{ Project.project1.admin.secret_key }} \
        aws --endpoint-url {{ ceph_endpoint }} iam put-user-policy \
          --user-name {{ item.0.value.name }} \
          --policy-name {{ item.1.value.name }} \
          --policy-document file:///tmp/policy_{{ item.0.value.name }}.json
      with_subelements:
        - "{{ Project.project1.users }}"
        - policies
      register: policy_assignment
      changed_when: "'Policy' in policy_assignment.stdout"

    # --- ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÐµÑ‚ Ð² Project ---
    - name: "ÐŸÑ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÐµÑ‚ Ð² Project"
      ansible.builtin.shell: |
        radosgw-admin user suspend --uid={{ item }}
      when: item not in Project.project1.users.keys()
      with_items: "{{ existing_users_list }}"
ðŸ”¥ Ð§Ñ‚Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾?
âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹

Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÐµÑÑ‚ÑŒ â†’ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ caps, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸.

Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½ÐµÑ‚ â†’ ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ ÐµÐ³Ð¾.

Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð±Ñ‹Ð», Ð½Ð¾ ÑƒÐ´Ð°Ð»Ñ‘Ð½ Ð¸Ð· Project â†’ ÑÑ‚Ð°Ð²Ð¸Ð¼ ÐµÐ³Ð¾ Ð½Ð° Ð¿Ð°ÑƒÐ·Ñƒ (suspend).

âœ… Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ AWS IAM API Ð´Ð»Ñ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº, Ð° Ð½Ðµ s3api put-bucket-policy.

âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ caps Ð´Ð»Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹

âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº, Ð½Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð½Ñ‹Ñ… Ð² Project.

âœ… Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ñ‚, Ñ‡Ñ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ, Ñ‚Ð°Ðº ÐºÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ register Ð¸ changed_when.

ðŸ”¥ Ð¢ÐµÐ¿ÐµÑ€ÑŒ ÑÑ‚Ð¾Ñ‚ Ansible Playbook Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÐµÑÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ! ðŸš€
